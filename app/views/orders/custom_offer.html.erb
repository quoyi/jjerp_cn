<div class="panel-warning">
  <div class="content-box-header panel-heading">
    <div class="panel-title">
      <h2 class="pull-left"><i class="fa fa-lg fa-desktop"></i> 自定义报价单 <small>详细</small> </h2>
      <div class="pull-right panel-options">
        <%= link_to '返回', indent_path(@indent), class: 'btn btn-info', data: {toggle:'tooltip'}, title: '返回到上一级' %>
      </div>
    </div>
  </div>
  <div class="content-box-large box-with-header" style="padding: 0px;">
    <%= nested_form_for @order, html: {class: 'form-inline', multipart: true} do |f| %>
    <%#= hidden_field_tag :is_custom, true%>
    <div class="modal-body" style="padding: 5px;">
      <!-- 部件 -->
      <div class="panel panel-default" id="orderUnitsForm">
        <div class="panel-heading order-panel-header">
          <h3 class="panel-title order-panel-header">板料&nbsp;&nbsp;&nbsp;&nbsp;
          <%= link_to '新建', '#', class: 'btn btn-info btn-xs', data: { toggle: 'modal', target: '#addMaterials'} %>
          <%= f.link_to_add '添加板料', :units, data: {target: '#orderUnitsForm'}, class: 'btn btn-info btn-xs pull-right' %>
          </h3>
        </div>
        <div class="panel-body" style="padding: 5px 0;">
          <%= f.fields_for :units, wrapper: false do |unit_form| %>
          <div class="fields">
            <% uf = unit_form.object %>
            <% if !uf.new_record? && !uf.is_custom %>
            <% else %>
            <% if uf.new_record? %><!-- 自定义报价才填写这些字段 -->
            <%= unit_form.hidden_field :full_name, value: '自定义' %>
            <%= unit_form.hidden_field :size, value: '自定义' %>
            <%= unit_form.hidden_field :is_custom, value: true %>
            <% end %>
            <div class="row">
              <div class="col-sm-11">
                <div class="row">
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>名称</label>
                  <%= unit_form.text_field :full_name, value: uf.new_record? ? @order.note : uf.full_name, class:'col-sm-2', required: true, placeholder: '请填写部件名称' %>
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>板料</label>
                  <%= unit_form.collection_select :ply, MaterialCategory.where(oftype:MaterialCategory.oftypes[:ply]),:id, :name, {selected: @order.ply}, {class: 'material-ply col-sm-1', onchange: 'getMaterialPrice(this)'} %>
                  <%= unit_form.collection_select :texture, MaterialCategory.where(oftype:MaterialCategory.oftypes[:texture]),:id, :name, {selected: @order.texture}, {class: 'material-texture col-sm-2', onchange: 'getMaterialPrice(this)'} %>
                  <%= unit_form.collection_select :color, MaterialCategory.where(oftype:MaterialCategory.oftypes[:color]),:id, :name, {selected: @order.color}, {class: 'material-color col-sm-2', onchange: 'getMaterialPrice(this)'} %>
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>单位</label>
                  <%= unit_form.collection_select :uom, Uom.where(deleted: false), :name, :name, {include_blank: '请选择', selected: '平方'}, {required: true, class: 'material-uom col-sm-2'} %>
                </div>
                <div class="row">
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>单价</label>
                  <%= unit_form.number_field :price, min: 0, step: 0.01, value: uf.new_record? ? @order.material_price : uf.price, required: true, class: 'material-price col-sm-2'  %>
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>长宽</label>
                  <%= unit_form.number_field :length, min: 0, step: 0.01, value: uf.new_record? ? 1 : uf.length, class: 'order-unit-length col-sm-1', onchange: 'setOrderUnitSize(this)', onblur: 'setOrderUnitSize(this)', required: true %>
                  <%= unit_form.number_field :width, min: 0, step: 0.01, value: uf.new_record? ? 1 : uf.width, class: 'order-unit-width col-sm-1', onchange: 'setOrderUnitSize(this)', onblur: 'setOrderUnitSize(this)', required: true %>
                  <!-- <label class="col-sm-1 text-right" style="margin: 7px 0;">尺寸</label> -->
                  <%= unit_form.text_field :size, value: uf.new_record? ? '' : uf.size, class: 'order-unit-size col-sm-3', placeholder: '请填写成型尺寸', onchange: 'setOrderUnitLengthWidth(this)', onblur: 'setOrderUnitLengthWidth(this)' %>
                  <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>数量</label>
                  <%= unit_form.text_field :number, min: 0, step: 0.01, value: uf.new_record? ? 1 : uf.number, class: 'col-sm-2', required: true  %>
                </div>
                <div class="row">
                  <label class="col-sm-1 text-right" style="margin: 7px 0;">备注</label>
                  <%= unit_form.text_field :note, value: uf.new_record? ? @order.note : uf.note, size: 15, class: 'col-sm-11', placeholder: '请填写备注信息' %>
                </div>
              </div>
              <div class="col-sm-1 text-center" style="margin: 30px 0;">
                <%= unit_form.link_to_remove '删除', class:'btn btn-info hidden' %>
                <%= link_to "删除", "javascript:void(0);", class: 'btn btn-info', onclick: 'delete_separate_from_nested_form(this)' %>
              </div>
            </div>
            <hr style="margin: 5px 0;" />
            <% end %>
          </div>
          <% end %>
        </div>
      </div>
      <!-- 配件 -->
      <div class="panel panel-default">
        <div class="panel-heading order-panel-header">
          <h3 class="panel-title order-panel-header">配件&nbsp;&nbsp;&nbsp;&nbsp;
          <%= link_to '新建', '#', class: 'btn btn-info btn-xs', data: { toggle: 'modal', target: '#addPartCategories'} %>
          <%= f.link_to_add '添加配件', :parts, data: {target: '#orderPartsForm'}, class: 'btn btn-info btn-xs pull-right' %>
          </h3>
        </div>
        <div class="panel-body" style="padding: 5px 0;">
          <div id="orderPartsForm">
            <%= f.fields_for :parts, wrapper: false do |part_form| %>
            <div class="fields">
              <div class="row">
                <% pf = part_form.object %>
                <div class="col-sm-11">
                  <div class="row">
                    <div class="">
                      <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>类型</label>
                      <%= part_form.collection_select :part_category_id, PartCategory.where(parent_id:0), :id, :name, {selected: PartCategory.find_by_id(pf.part_category_id).try(:parent_id), include_blank: "请选择"}, {required: true, class: 'parent-part-category col-sm-1', onchange: 'setChildPartCategory(this)'} %>
                      <%= part_form.collection_select :part_category_id, PartCategory.where.not(parent_id:0), :id, :name, {selected: pf.part_category_id, include_blank: "请选择"}, {required: true, class: 'child-part-category col-sm-2', onchange: 'setPartCategoryPrice(this)'} %>
                    </div>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>单位</label>
                    <%= part_form.collection_select :uom, Uom.where(deleted: false), :name, :name, {value: pf.uom, include_blank: "请选择"}, {required: true, class: 'part-category-uom col-sm-1'}%>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;">单价</label>
                    <%= part_form.number_field :price, min: 0, step: 0.01, value: pf.new_record? ? 0 : pf.price, class: 'part-category-price col-sm-1', required: true  %>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;">数量</label>
                    <%= part_form.number_field :number, min: 0, step: 0.01, value: pf.new_record? ? 1 : pf.number, required: true, class: "col-sm-1" %>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>供应商</label>
                    <%= part_form.collection_select :supply_id, Supply.all, :id, :full_name, {selected: pf.supply_id,include_blank: "请选择"}, {required: true, class: "part-category-supply col-sm-1"}%>
                  </div>
                  <div class="row">
                    <label class="col-sm-1 text-right" style="margin: 7px 0;">备注</label>
                    <%= part_form.text_field :note, value: pf.new_record? ? @order.note : pf.note, class: 'col-sm-11', placeholder: '请填写备注信息'%>
                  </div>
                </div>
                <div class="col-sm-1 text-center" style="margin: 14px 0;">
                  <%= part_form.link_to_remove '删除', class:'btn btn-info hidden' %>
                  <%= link_to "删除", "javascript:void(0);", class: 'btn btn-info', onclick: 'delete_separate_from_nested_form(this)' %>
                </div>
              </div>
              <hr style="margin: 5px 0;" />
            </div>
            <% end %>
          </div>
        </div>
      </div>
      <!-- 工艺 -->
      <div class="panel panel-default">
        <div class="panel-heading order-panel-header">
          <h3 class="panel-title order-panel-header">工艺&nbsp;&nbsp;&nbsp;&nbsp;
          <%= link_to '新建', '#', class: 'btn btn-info btn-xs', data: { toggle: 'modal', target: '#addCraftCategory'}, title: '新建工艺' %>
          <%= f.link_to_add '添加工艺', :crafts, data: {target: '#orderCraftsForm'}, class: 'btn btn-info btn-xs pull-right' %>
          </h3>
        </div>
        <div class="panel-body" style="padding: 5px 0;">
          <div id="orderCraftsForm">
            <%= f.fields_for :crafts, wrapper: false do |craft_form| %>
            <div class="fields">
              <div class="row">
                <% cf = craft_form.object %>
                <div class="col-sm-11">
                  <div class="row">
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>名称</label>
                    <%= craft_form.collection_select :craft_category_id, CraftCategory.where(deleted: false), :id, :full_name, {include_blank: '请选择'}, {class: 'col-sm-3', required: true, onchange: 'setCraft(this)'}%>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>单位</label>
                    <%= craft_form.collection_select :uom, Uom.where(deleted: false), :name, :name, {include_blank: '请选择'}, {class: 'col-sm-1 order_craft_uom', required: true} %>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>单价</label>
                    <%= craft_form.number_field :price, min: 0, step: 0.01, value: cf.new_record? ? 0 : cf.price, required: true, class: 'col-sm-1 order_craft_price' %>
                    <label class="col-sm-1 text-right" style="margin: 7px 0;"><span class="require">*</span>数量</label>
                    <%= craft_form.number_field :number, min: 0, step: 0.01, value: cf.new_record? ? 1 : cf.number, class: 'col-sm-1', required: true %>
                  </div>
                  <div class="row">
                    <label class="col-sm-1 text-right">备注</label>
                    <%= craft_form.text_field :note, value: cf.new_record? ? '' : cf.note, class: 'col-sm-11', placeholder: '请填写备注信息'%>
                  </div>
                </div>
                <div class="col-sm-1 text-center" style="margin: 12px 0;">
                  <%= craft_form.link_to_remove '删除', class:'btn btn-info hidden' %>
                  <%= link_to "删除", "javascript:void(0);", class: 'btn btn-info', onclick: 'delete_separate_from_nested_form(this)' %>
                </div>
              </div>
              <hr style="margin: 5px 0;" />
            </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="row" style="padding: 0 20px 10px 20px;">
        <div class="pull-right">
          <%= f.submit '提交', class: 'btn btn-primary' %>
        </div>
      </div>
    </div>
    <% end %>
  </div>
</div>
<%= render '/materials/new' %>
<%= render '/part_categories/new' %>
<%= render '/craft_categories/new' %>

<script type="text/javascript">
function delete_separate_from_nested_form(obj){
  var order_fields = $(obj).parent().siblings(".col-sm-11");
  var required_order_fields = order_fields.find("[required='required']");
  console.log(required_order_fields);
  // 动态删除子订单前，将必填项的值设为1
  required_order_fields.each(function(){
    var element = $(this);
    if(element.is("select")){
      element.children().last().attr("selected", "selected");
    }else{
      element.val("1");
    }
  });
  $(obj).prev().click();
}
</script>